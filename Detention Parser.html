<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>St James Detention Processor</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
        }
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        /************************************************
         * HEADER STYLES
         ************************************************/
        .header-container {
            display: flex;
            align-items: center;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header-container img {
            max-height: 80px;
        }
        .header-titles {
            margin-left: 20px;
        }
        .header-titles h1 {
            font-size: 24px;
            margin: 0;
            color: #333;
        }
        .header-titles h2 {
            font-size: 14px;
            margin: 5px 0 0;
            color: #777;
        }
        /* Button Styles */
        button {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #button-reset {
            color: #fff;
            background-color: #dc3545;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        }
        #button-reset:hover {
            background-color: #c82333;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.4);
        }
        #button-classify-detentions {
            color: #fff;
            background-color: #007bff;
            cursor: not-allowed;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            width: 620px;
        }
        #button-classify-detentions:enabled {
            cursor: pointer;
            background-color: #28a745;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }
        #button-classify-detentions:enabled:hover {
            background-color: #218838;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.4);
        }
        #button-generate-asdtoday-docs {
            color: #fff;
            background-color: #6f42c1;
            cursor: not-allowed;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #button-generate-asdtoday-docs:enabled {
            cursor: pointer;
            background-color: #8a4be2;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }
        #button-generate-asdtoday-docs:enabled:hover {
            background-color: #5a32a3;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.4);
        }
        #button-download-spreadsheet {
            color: #fff;
            background-color: #17a2b8;
            cursor: not-allowed;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #button-download-spreadsheet:enabled {
            cursor: pointer;
            background-color: #138496;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }
        #button-download-spreadsheet:enabled:hover {
            background-color: #0f6674;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.4);
        }
        .copy-button {
            color: #fff;
            background-color: #28a745;
        }
        .copy-button:hover {
            background-color: #218838;
        }
        .download-button {
            color: #fff;
            background-color: #007bff;
        }
        .download-button:hover {
            background-color: #0056b3;
        }
        #email-report-button {
            color: #fff;
            background-color: #ff9800;
            cursor: not-allowed;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #email-report-button:enabled {
            cursor: pointer;
            background-color: #ff5722;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }
        #email-report-button:enabled:hover {
            background-color: #e64a19;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.4);
        }
        /* Drop Zone Styles */
        #dropZone {
            margin: 50px 0;
            height: 200px;
            border-radius: 10px;
            border: 2px dashed #8400ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #555;
            background-color: rgba(206, 110, 183, 0.54);
        }
        #dropZone.dragover {
            border-color: #00f;
            color: #00f;
        }
        .drop-zone-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 50px 0;
            gap: 20px;
        }
        .drop-zone {
            width: 300px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 16px;
            border: 2px solid;
        }
        #drop-zone-detention-list {
            border-color: #007bff;
            color: #007bff;
        }
        #drop-zone-timetable-list {
            border-color: #8400ff;
            color: #8400ff;
        }
        #drop-zone-student-list {
            border-color: #ff00d5;
            color: #ff00d5;
        }
        .drop-zone.dragover {
            background-color: #e0f7ff;
        }
        /* Table Container Styles */
        .student-lists-container {
            margin: 0 0 20px 0;
        }
        /* Styles for each Detention Type Section (optional, TO Today, ASD Today, etc.) */
        .optional-students-container {
            border: 2px solid #17a2b8;
            background-color: #eaf7fa;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .optional-students-container h3 {
            background-color: #17a2b8;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 0;
        }
        .optional-students-container table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #17a2b8;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .optional-students-container th {
            background-color: #17a2b8;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px;
        }
        .optional-students-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .optional-students-container tr:hover {
            background-color: #e0f7ff;
        }
        .optional-students-container td {
            padding: 10px;
            color: #333;
        }
        .toToday-students-container {
            border: 2px solid #ff8c00;
            background-color: #fff7ea;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .toToday-students-container h3 {
            background-color: #ff8c00;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 0;
        }
        .toToday-students-container table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ff8c00;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .toToday-students-container th {
            background-color: #ff8c00;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px;
        }
        .toToday-students-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .toToday-students-container tr:hover {
            background-color: #ffe8cf;
        }
        .toToday-students-container td {
            padding: 10px;
            color: #333;
        }
        .asdtoday-students-container {
            border: 2px solid #dc3545;
            background-color: #faeaea;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .asdtoday-students-container h3 {
            background-color: #dc3545;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 0;
        }
        .asdtoday-students-container table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #dc3545;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .asdtoday-students-container th {
            background-color: #dc3545;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px;
        }
        .asdtoday-students-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .asdtoday-students-container tr:hover {
            background-color: #f9d6d9;
        }
        .asdtoday-students-container td {
            padding: 10px;
            color: #333;
        }
        .homework-texts-container {
            border: 2px solid #ffa500;
            background-color: #fffbe6;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .homework-texts-container h3 {
            background-color: #ffa500;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 0;
        }
        .homework-texts-container table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ffa500;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .homework-texts-container th {
            background-color: #ffa500;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px;
        }
        .homework-texts-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .homework-texts-container tr:hover {
            background-color: #fff2d9;
        }
        .homework-texts-container td {
            padding: 10px;
            color: #333;
        }
        .absent-students-container {
            border: 2px solid #6c757d;
            background-color: #f8f9fa;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .absent-students-container h3 {
            background-color: #6c757d;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 0;
        }
        .absent-students-container table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #6c757d;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .absent-students-container th {
            background-color: #6c757d;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px;
        }
        .absent-students-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .absent-students-container tr:hover {
            background-color: #e9ecef;
        }
        .absent-students-container td {
            padding: 10px;
            color: #333;
        }
        .two-hour-asd-container {
            border: 2px solid #007bff;
            background-color: #e7f3ff;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .two-hour-asd-container h3 {
            background-color: #007bff;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 0;
        }
        .two-hour-asd-container table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #007bff;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .two-hour-asd-container th {
            background-color: #007bff;
            color: #fff;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px;
        }
        .two-hour-asd-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .two-hour-asd-container tr:hover {
            background-color: #e0f7ff;
        }
        .two-hour-asd-container td {
            padding: 10px;
            color: #333;
        }
        .instructions-container {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .instructions-container h2 {
            margin-top: 0;
            color: #333;
        }
        .instructions-container p,
        .instructions-container li {
            font-size: 16px;
            color: #555;
        }
        .nav-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        #nav-toggle {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }
        #nav-toggle:hover {
            background: rgba(0, 0, 0, 0.9);
        }
        .floating-nav {
            display: none;
            position: absolute;
            top: 35px;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .nav-container:hover .floating-nav {
            display: block;
        }
        .floating-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .floating-nav li {
            margin: 5px 0;
        }
        .floating-nav a {
            display: block;
            color: white;
            text-decoration: none;
            font-size: 12px;
            padding: 5px 10px;
            transition: background 0.3s;
        }
        .floating-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        html {
            scroll-behavior: smooth;
        }
        .hidden {
            display: none;
        }
    </style>
    <!-- Vanilla-DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.css">
</head>
<body>
<!-- Compact Floating Navigation Menu -->
<div class="nav-container">
    <button id="nav-toggle">☰ Menu</button>
    <nav class="floating-nav">
        <ul>
            <li><a href="#">⬆️ Top</a></li>
            <li><a href="#absent-students">🚫 Absent</a></li>
            <li><a href="#optional-students">✅ Removed</a></li>
            <li><a href="#toToday-students">📅 TO Today</a></li>
            <li><a href="#asdtoday-students">📌 ASD Today</a></li>
            <li><a href="#homework-texts">✉️ ASD Text</a></li>
        </ul>
    </nav>
</div>

<div class="page-container">
    <!-- HEADER CONTAINER -->
    <div class="header-container">
        <!-- Logo image (Base64 code truncated for brevity) -->
        <img src="data:image/png;base64,...(base64 code truncated)..." alt="School Logo" />
        <div class="header-titles">
            <h1>St James Detentions Processor</h1>
            <h2>developed by Rob Morse</h2>
        </div>
    </div>

    <!-- Instructions Section -->
    <div class="instructions-container">
        <h2>Instructions</h2>
        <p>Please follow these steps to upload your files:</p>
        <ol>
            <li>Drop all three data files needed into the drop zone (these files should not be renamed before using):
                <ul>
                    <li>Detentions file downloaded from classcharts</li>
                    <li>Student list report from Bromcom</li>
                    <li>Timetable report from Bromcom</li>
                </ul>
            </li>
            <li>Click "Classify Detentions"</li>
            <li>This will generate several lists as needed</li>
            <li>You can then download the slips to hand out and the daily summary spreadsheet</li>
        </ol>
        <p>If you need to start over at any time, click the “Reset” button.</p>
    </div>

    <!-- Main Drop Zone for Files -->
    <div id="dropZone">Drop files here for processing</div>

    <!-- Individual Drop Zones -->
    <div class="drop-zone-container">
        <div id="drop-zone-detention-list" class="drop-zone">Detentions</div>
        <div id="drop-zone-timetable-list" class="drop-zone">Timetables</div>
        <div id="drop-zone-student-list" class="drop-zone">Students</div>
        <div id="template-loaded-indicator" class="drop-zone" style="border-color: #28a745; color: #28a745;">Template Not Loaded</div>
    </div>

    <button id="button-classify-detentions" disabled>Classify Detentions</button>
    <br>
    <!-- Buttons -->
    <button id="button-generate-asdtoday-docs" disabled>Generate ASD Today Docs</button>
    <button id="button-download-spreadsheet" disabled>Download Spreadsheet</button>
    <button id="email-report-button" disabled>📧 Email Report</button>
    <br>
    <button id="button-reset" onclick="resetPage()">Reset</button>

    <!-- Tables for Results -->
    <div class="student-lists-container">
        <!-- Absent Students -->
        <div id="absent-students" class="student-table-container absent-students-container">
            <h3>Absent Students</h3>
            <button class="copy-button" onclick="copyTableToClipboard('absent-student-table')">Copy to Clipboard</button>
            <button class="download-button" onclick="downloadTableAsCSV('absent-student-table', 'Absent Students')">Download as CSV</button>
            <table id="absent-student-table"></table>
        </div>

        <!-- Optional Students -->
        <div id="optional-students" class="student-table-container optional-students-container">
            <h3>Students removed as homework optional</h3>
            <button class="copy-button" onclick="copyTableToClipboard('optional-student-table')">Copy to Clipboard</button>
            <button class="download-button" onclick="downloadTableAsCSV('optional-student-table', 'Optional Students')">Download as CSV</button>
            <table id="optional-student-table"></table>
        </div>

        <!-- TO Today Students -->
        <div id="toToday-students" class="student-table-container toToday-students-container">
            <h3>Students moved to TO Today</h3>
            <button class="copy-button" onclick="copyTableToClipboard('TOT-student-table')">Copy to Clipboard</button>
            <button class="download-button" onclick="downloadTableAsCSV('TOT-student-table', 'TO Today Students')">Download as CSV</button>
            <table id="TOT-student-table"></table>
        </div>

        <!-- ASD Today -->
        <div id="asdtoday-students" class="student-table-container asdtoday-students-container">
            <h3>All after school detention students for today</h3>
            <button class="copy-button" onclick="copyTableToClipboard('ASDToday-student-table')">Copy to Clipboard</button>
            <button class="download-button" onclick="downloadTableAsCSV('ASDToday-student-table', 'ASD Today')">Download as CSV</button>
            <table id="ASDToday-student-table"></table>
        </div>

        <!-- Homework Detention Texts -->
        <div id="homework-texts" class="student-table-container homework-texts-container">
            <h3>Students to send texts home for detention today</h3>
            <button class="copy-button" onclick="copyTableToClipboard('homework-texts-table')">Copy to Clipboard</button>
            <button class="download-button" onclick="downloadTableAsCSV('homework-texts-table', 'Homework Detention Texts')">Download as CSV</button>
            <table id="homework-texts-table"></table>
        </div>

        <!-- TWO HOUR ASD Detentions -->
        <div id="two-hour-asd" class="student-table-container two-hour-asd-container">
            <h3>TWO HOUR ASD Detentions</h3>
            <button class="copy-button" onclick="copyTableToClipboard('two-hour-asd-table')">Copy to Clipboard</button>
            <button class="download-button" onclick="downloadTableAsCSV('two-hour-asd-table', 'TWO HOUR ASD Detentions')">Download as CSV</button>
            <table id="two-hour-asd-table"></table>
        </div>
    </div>

    <!-- Output Section -->
    <div id="output"></div>
</div>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/pizzip@3.1.7/dist/pizzip.js"></script>
<script src="https://unpkg.com/pizzip@3.1.7/dist/pizzip-utils.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.57.1/docxtemplater.min.js" integrity="sha512-TRYli2oUTOtkaL8mPsLYAqcg2xmGOuKNkYHNsbCQU3fhchKedp6vlkdNdDKt7wEW2uGV0dF2be9sldHKGnZDWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Vanilla-DataTables JS -->
<script src="https://cdn.jsdelivr.net/npm/vanilla-datatables@latest/dist/vanilla-dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    /***********************
     * Global Variables
     ***********************/
    let students = {};
    let detentions = [];

    let optionalDetentions = [];
    let ASDToday = [];
    let TOToday = [];
    let homeworkDetentionTexts = [];
    let slips = [];
    let twoHourASDDetentions = [];

    let filesLoaded = {
        detentionList: false,
        timetableList: false,
        studentList: false,
    };

    let doc_template = null;

    /***********************
     * Event Listeners
     ***********************/
    const dropZone = document.getElementById("dropZone");
    const buttonClassify = document.getElementById("button-classify-detentions");

    dropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropZone.classList.remove("dragover");
        const files = event.dataTransfer.files;
        for (let i = 0; i < files.length; i++) {
            handleFile(files[i]);
        }
    });

    buttonClassify.addEventListener("click", classifyDetentions);

    /***********************
     * File Processing
     ***********************/
    function handleFile(file) {
        const name = file.name.toLowerCase();
        if (name.endsWith(".docx")) {
            processDocxFile(file);
        } else if (name.includes("detentions")) {
            processDetentionFile(file);
        } else if (name.includes("student lists")) {
            processStudentListsFile(file);
        } else if (name.includes("locations")) {
            processLocationsFile(file);
        } else {
            console.warn(`Unrecognized file: ${file.name}`);
            Swal.fire({
                icon: 'error',
                title: 'Unrecognized file',
                text: file.name || error,
            });
        }
    }

    async function processDocxFile(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const zip = new PizZip(arrayBuffer);
            doc_template = new docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
            });
            console.log("DOCX template loaded successfully!");
            document.getElementById("template-loaded-indicator").innerText = "Template Loaded ✅";
            document.getElementById("template-loaded-indicator").style.borderColor = "#28a745";
            document.getElementById("template-loaded-indicator").style.color = "#28a745";
        } catch (error) {
            console.error("Error processing DOCX file:", error);
        }
    }

    async function processDetentionFile(file) {
        try {
            const jsonData = await parseExcelFile(file);
            detentions = [...detentions, ...jsonData];
            document.getElementById("drop-zone-detention-list").innerText = `Detention List Loaded (${jsonData.length})`;
            filesLoaded.detentionList = true;
            checkFilesLoaded();
        } catch (error) {
            displayError("Error processing detention file.");
        }
    }

    async function processStudentListsFile(file) {
        try {
            const jsonData = await parseExcelFile(file);
            jsonData.forEach(student => {
                if (!students[student.UPN]) {
                    students[student.UPN] = { details: student };
                } else {
                    students[student.UPN].details = student;
                }
            });
            document.getElementById("drop-zone-student-list").innerText = `Student List Loaded (${jsonData.length})`;
            filesLoaded.studentList = true;
            checkFilesLoaded();
        } catch (error) {
            displayError("Error processing student list file.");
        }
    }

    async function processLocationsFile(file) {
        try {
            const jsonData = await parseExcelFile(file);
            jsonData.forEach(row => {
                const upn = row.UPN;
                const period = row["Period Display Name"];
                if (!students[upn]) {
                    students[upn] = { timetable: {} };
                }
                if (!students[upn].timetable) {
                    students[upn].timetable = {};
                }
                students[upn].timetable[period] = row;
            });
            document.getElementById("drop-zone-timetable-list").innerText = `Timetable List Loaded (${jsonData.length})`;
            filesLoaded.timetableList = true;
            checkFilesLoaded();
        } catch (error) {
            console.error("Error processing timetable file:", error);
            displayError("Error processing timetable file.");
        }
    }

    async function parseExcelFile(file) {
        const fileData = await file.arrayBuffer();
        const workbook = XLSX.read(fileData, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        return XLSX.utils.sheet_to_json(sheet);
    }

    /***********************
     * Helper Functions
     ***********************/
    function classifyDetentions() {
        for (const detention of detentions) {
            let student;
            if (detention["Pupil ID"] in students) {
                student = students[detention["Pupil ID"]];
            } else {
                continue;
            }
            detention["presentToday"] = student.details["Attendance Today"] ?? "";
            detention["homeworkStatus"] = student.details["Homework Status"] ?? "";
            detention["schoolBus"] = student.details["School Bus"] ?? "";
            detention["noDetentions"] = student.details["No Detentions"] ?? "";

            const now = new Date();
            const dayMap = { 1: "MON", 2: "TUE", 3: "WED", 4: "THU", 5: "FRI" };
            const currentDay = dayMap[now.getDay()];

            if (!currentDay) {
                detention["noticeClassName"] = "";
                detention["noticeRoom"] = "";
                detention["noticeStaffCode"] = "";
                detention["noticePeriod"] = "";
                detention["collectionClassName"] = "";
                detention["collectionRoom"] = "";
                detention["collectionStaffCode"] = "";
                detention["collectionPeriod"] = "";
                continue;
            }

            const noticeLastDigit = (currentDay === "TUE") ? "5" : "4";
            const noticeSuffix = currentDay + noticeLastDigit;
            let noticeEntry = null;
            for (const key in student.timetable) {
                if (key.slice(1) === noticeSuffix) {
                    noticeEntry = student.timetable[key];
                    break;
                }
            }
            if (!noticeEntry) {
                noticeEntry = {};
            }
            detention["noticeClassName"] = noticeEntry["Class Name"] ?? "";
            detention["noticeRoom"] = noticeEntry["Room"] ?? "";
            detention["noticeStaffCode"] = noticeEntry["Staff Code"] ?? "";
            detention["noticePeriod"] = noticeEntry["Period Display Name"] ?? "";

            const collectionLastDigit = (currentDay === "TUE") ? "6" : "5";
            let collectionSuffix = currentDay + collectionLastDigit;
            collectionSuffix = (currentDay === "WED") ? "LECTIVE2" : collectionSuffix;
            let collectionEntry = null;
            for (const key in student.timetable) {
                if (key.slice(1) === collectionSuffix) {
                    collectionEntry = student.timetable[key];
                    break;
                }
            }
            if (!collectionEntry) {
                collectionEntry = {};
            }
            detention["collectionClassName"] = collectionEntry["Class Name"] ?? "";
            detention["collectionRoom"] = collectionEntry["Room"] ?? "";
            detention["collectionStaffCode"] = collectionEntry["Staff Code"] ?? "";
            detention["collectionPeriod"] = collectionEntry["Period Display Name"] ?? "";
        }

        let leftoverDetentions = [...detentions];
        optionalDetentions = detentions.filter(d => d.homeworkStatus === "Optional homework" && d["Detention type"] === "Homework Detention");
        leftoverDetentions = detentions.filter(d => !(d.homeworkStatus === "Optional homework" && d["Detention type"] === "Homework Detention"));

        absentDetentions = leftoverDetentions.filter(d => d.presentToday === 0);
        leftoverDetentions = leftoverDetentions.filter(d => d.presentToday !== 0);

        TOToday = leftoverDetentions
            .filter(d => ((d["Year group"] === 7 || d["Year group"] === 8) && d.schoolBus === "Yes") || d.noDetentions === "Yes")
            .map(d => ({ ...d, TO: "yes" }));
        leftoverDetentions = leftoverDetentions
            .filter(d => !(((d["Year group"] === 7 || d["Year group"] === 8) && d.schoolBus === "Yes") || d.noDetentions === "Yes"));
        ASDToday = leftoverDetentions.map(d => ({ ...d, ASD: "yes" }));
        homeworkDetentionTexts = ASDToday.filter(d => d["Detention type"] === "Homework Detention");
        slips = [...ASDToday, ...TOToday];

        function parseNoticeRoom(room) {
            const match = room.match(/^([A-Za-z])(\d+)$/);
            if (!match) return null;
            return { letter: match[1], number: parseInt(match[2], 10) };
        }
        slips.sort((a, b) => {
            const roomA = parseNoticeRoom(a.noticeRoom);
            const roomB = parseNoticeRoom(b.noticeRoom);
            if (roomA && roomB) {
                if (roomA.letter < roomB.letter) return -1;
                if (roomA.letter > roomB.letter) return 1;
                return roomA.number - roomB.number;
            }
            if (roomA && !roomB) return -1;
            if (!roomA && roomB) return 1;
            return 0;
        });
        twoHourASDDetentions = ASDToday.filter(d => d["Detention type"] === "TWO HOUR ASD");

        generateStudentTable("optional-student-table", optionalDetentions);
        generateStudentTable("TOT-student-table", TOToday);
        generateStudentTable("ASDToday-student-table", ASDToday);
        generateStudentTable("homework-texts-table", homeworkDetentionTexts);
        generateStudentTable("absent-student-table", absentDetentions);
        generateStudentTable("two-hour-asd-table", twoHourASDDetentions);
    }

    function generateStudentTable(tableId, data) {
        const table = document.getElementById(tableId);
        table.innerHTML = "";
        const thead = `<thead>
        <tr>
          <th class="hidden">UPN</th>
          <th>Tutor</th>
          <th>Name</th>
          <th>Detention Type</th>
          <th>Behaviour Type</th>
          <th>Notice Room</th>
          <th class="hidden">Notice Class</th>
          <th class="hidden">Notice Teacher</th>
          <th>Collection Room</th>
          <th class="hidden">Collection Class</th>
          <th class="hidden">Collection Teacher</th>
          <th>Homework Status</th>
          <th>Bus</th>
          <th>No Detentions</th>
        </tr>
      </thead>`;
        const tbody = data.map(d => `
        <tr>
          <td class="hidden">${d["Pupil ID"]}</td>
          <td>${d["Tutor group"]}</td>
          <td>${d["First name"]} ${d["Last name"]}</td>
          <td>${d["Detention type"]}</td>
          <td>${d["Behaviour type"]}</td>
          <td>${d["noticeRoom"]}</td>
          <td class="hidden">${d["noticeClassName"]}</td>
          <td class="hidden">${d["noticeStaffCode"]}</td>
          <td>${d["collectionRoom"]}</td>
          <td class="hidden">${d["collectionClassName"]}</td>
          <td class="hidden">${d["collectionStaffCode"]}</td>
          <td>${d["homeworkStatus"]}</td>
          <td>${d["schoolBus"]}</td>
          <td>${d["noDetentions"]}</td>
        </tr>`).join("");
        table.innerHTML = thead + `<tbody>${tbody}</tbody>`;
        // Initialize Vanilla-DataTables on this table
        new DataTable(table, {
            searchable: true,
            sortable: true,
            fixedHeight: true,
        });
        document.getElementById("button-generate-asdtoday-docs").disabled = false;
        document.getElementById("email-report-button").disabled = false;
        document.getElementById("button-download-spreadsheet").disabled = false;
    }

    // Modified CSV export function that uses the raw data arrays (which contain all rows)
    function downloadTableAsCSV(tableId, tableTitle) {
        // Map table IDs to their underlying data arrays
        const tableDataMap = {
            "absent-student-table": absentDetentions,
            "optional-student-table": optionalDetentions,
            "TOT-student-table": TOToday,
            "ASDToday-student-table": ASDToday,
            "homework-texts-table": homeworkDetentionTexts,
            "two-hour-asd-table": twoHourASDDetentions
        };

        const data = tableDataMap[tableId] || [];
        // Define headers and the corresponding keys (or computed values) in the desired order
        const headers = [
            "UPN", "Tutor", "Name", "Detention Type", "Behaviour Type",
            "Notice Room", "Notice Class", "Notice Teacher",
            "Collection Room", "Collection Class", "Collection Teacher",
            "Homework Status", "Bus", "No Detentions"
        ];

        // Build CSV content
        const csvRows = [];
        csvRows.push(headers.map(h => `"${h}"`).join(","));
        data.forEach(d => {
            const row = [
                d["Pupil ID"],
                d["Tutor group"],
                `${d["First name"]} ${d["Last name"]}`,
                d["Detention type"],
                d["Behaviour type"],
                d["noticeRoom"],
                d["noticeClassName"],
                d["noticeStaffCode"],
                d["collectionRoom"],
                d["collectionClassName"],
                d["collectionStaffCode"],
                d["homeworkStatus"],
                d["schoolBus"],
                d["noDetentions"]
            ];
            csvRows.push(row.map(cell => `"${cell}"`).join(","));
        });
        const csvContent = csvRows.join("\n");
        const currentDate = new Date().toISOString().split("T")[0];
        const filename = `${tableTitle.replace(/\s+/g, '_')}_${currentDate}.csv`;
        const blob = new Blob([csvContent], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function copyTableToClipboard(tableId) {
        const table = document.getElementById(tableId);
        const rows = Array.from(table.rows);
        const text = rows
            .map(row => Array.from(row.cells).map(cell => cell.innerText).join("\t"))
            .join("\n");
        navigator.clipboard.writeText(text)
            .then(() => alert("Table copied to clipboard!"))
            .catch(err => console.error("Failed to copy table: ", err));
    }

    function checkFilesLoaded() {
        buttonClassify.disabled = !(filesLoaded.detentionList && filesLoaded.timetableList && filesLoaded.studentList);
    }

    function resetPage() {
        location.reload();
    }

    function displayError(message) {
        document.getElementById("output").innerHTML = `<p style="color: red;">${message}</p>`;
    }

    document.getElementById("button-generate-asdtoday-docs").addEventListener("click", generateASDTodayDocs);
    function generateASDTodayDocs() {
        if (!doc_template) {
            alert("No .docx template loaded yet!");
            return;
        }
        try {
            const zip = new PizZip(doc_template.zip.generate({ type: "arraybuffer" }));
            const doc = new docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
            });
            let roundedCount = Math.ceil(slips.length / 4) * 4;
            let ordered_slips = new Array(roundedCount);
            function calculateValue(detentionNumber, no_detentions) {
                return (detentionNumber % (no_detentions / 4)) * 4 + Math.floor(detentionNumber / (no_detentions / 4));
            }
            slips.forEach((detention, index) => {
                detention.index = index;
                ordered_slips[calculateValue(index, roundedCount)] = detention;
            });
            doc.render({ detentions: ordered_slips });
            const blob = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                compression: "DEFLATE",
            });
            saveAs(blob, "ASDToday_Document.docx");
        } catch (error) {
            console.error("Error generating document:", error);
            alert("An error occurred while generating the document.");
        }
    }

    document.getElementById("button-download-spreadsheet").addEventListener("click", downloadSpreadsheet);
    function downloadSpreadsheet() {
        const workbook = XLSX.utils.book_new();
        const tables = {
            "Absent Students": absentDetentions,
            "Optional Students": optionalDetentions,
            "TO Today Students": TOToday,
            "ASD Today": ASDToday,
            "Homework Detention Texts": homeworkDetentionTexts
        };
        for (const [sheetName, data] of Object.entries(tables)) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
        }
        XLSX.writeFile(workbook, `Detention_Report_${new Date().toISOString().split("T")[0]}.xlsx`);
    }

    document.addEventListener("click", function(event) {
        const nav = document.querySelector(".floating-nav");
        const button = document.getElementById("nav-toggle");
        if (nav.style.display === "block" && !button.contains(event.target) && !nav.contains(event.target)) {
            nav.style.display = "none";
        }
    });

    document.getElementById("email-report-button").addEventListener("click", composeEmail);
    function composeEmail() {
        if (optionalDetentions.length === 0 && absentDetentions.length === 0 && TOToday.length === 0) {
            alert("No students to report.");
            return;
        }
        let emailAddress = "mark.barlow@stjamesexeter.co.uk";
        let subject = "Detention Report - Optional, Absent & TO Today";
        let optionalList = optionalDetentions.map(d => `- ${d["First name"]} ${d["Last name"]} (${d["Behaviour type"]})`).join("\n");
        let absentList = absentDetentions.map(d => `- ${d["First name"]} ${d["Last name"]} (${d["Behaviour type"]})`).join("\n");
        let toTodayList = TOToday.map(d => `- ${d["First name"]} ${d["Last name"]} (${d["Behaviour type"]})`).join("\n");
        let body = `Hello,\n\nHere is the list of students for today:\n\n` +
            `Optional Homework Students Removed:\n${optionalList || "None"}\n\n` +
            `Absent Students:\n${absentList || "None"}\n\n` +
            `Students Moved to TO Today:\n${toTodayList || "None"}\n\nRegards,\nSt James Detentions Processor`;
        navigator.clipboard.writeText(body).then(() => {
            alert("Email content copied to clipboard. Open the email and paste it.");
        }).catch(err => {
            console.error("Failed to copy text:", err);
            alert("Failed to copy email content. Please copy manually.");
        });
        window.location.href = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}`;
    }
</script>
</body>
</html>